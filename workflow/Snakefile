# [Standard Structure] Config is now in the config/ folder
configfile: "config/config.yaml"

# --- Target Rule ---
rule all:
    input:
        directory(f"{config['output_dir']}/3_Analysis")

# --- Rule 1: Preprocessing ---
rule prepare_data:
    input:
        scst = config["scst_data"],
        bulk = config["bulk_expression"],
        cli = config["bulk_clinical"]
    output:
        pkl_dir = directory(f"{config['output_dir']}/2_preprocessing")
    params:
        datatype = config["datatype"],
        mode = config["mode"],
        outdir = config["output_dir"],
        norm_flag = "--lognormalize" if config["preprocessing"].get("lognormalize") else ""
    # [Reviewer Request] Bioconda Integration:
    # This automatically builds an isolated environment with TiRank installed.
    conda:
        "envs/tirank.yaml"
    # [Best Practice] Log files for debugging
    log:
        f"{config['output_dir']}/logs/prepare_data.log"
    shell:
        """
        python ../tirank/tirank_cli.py prepare \
            --scst_exp {input.scst} \
            --bulk_exp {input.bulk} \
            --bulk_cli {input.cli} \
            --datatype {params.datatype} \
            --mode {params.mode} \
            --save_path {params.outdir} \
            {params.norm_flag} > {log} 2>&1
        """

# --- Rule 2: Analysis ---
rule run_tirank:
    input:
        prep_dir = f"{config['output_dir']}/2_preprocessing"
    output:
        res_dir = directory(f"{config['output_dir']}/3_Analysis")
    params:
        datatype = config["datatype"],
        mode = config["mode"],
        outdir = config["output_dir"],
        device = config["model"]["device"],
        tol = config["model"]["tolerance"]
    conda:
        "envs/tirank.yaml"
    log:
        f"{config['output_dir']}/logs/run_tirank.log"
    shell:
        """
        python ../tirank/tirank_cli.py run \
            --save_path {params.outdir} \
            --datatype {params.datatype} \
            --mode {params.mode} \
            --device {params.device} \
            --tolerance {params.tol} > {log} 2>&1
        """