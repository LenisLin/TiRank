configfile: "config.yaml"

# Note: If you use this alternative, you might need to delete the 3_Analysis folder before re-running Snakemake, so it knows it needs to re-create it.

# --- Target Rule ---
# Snakemake works backwards from here. It wants this specific PNG file.
rule all:
    input:
        directory(f"{config['output_dir']}/3_Analysis")

# --- Rule 1: Preprocessing ---
rule prepare_data:
    input:
        scst = config["scst_data"],
        bulk = config["bulk_expression"],
        cli = config["bulk_clinical"]
    output:
        # We track the directory to know when this step is done.
        pkl_dir = directory(f"{config['output_dir']}/2_preprocessing")
    params:
        datatype = config["datatype"],
        mode = config["mode"],
        outdir = config["output_dir"],
        # Safer way to get boolean flags from config
        norm_flag = "--lognormalize" if config["preprocessing"].get("lognormalize") else ""
    # conda:
    #     "../installation/environment.yml"
    shell:
        # NOTE: Ensure tirank_cli.py is in the PROJECT ROOT (one level up)
        """
        python ../tirank/tirank_cli.py prepare \
            --scst_exp {input.scst} \
            --bulk_exp {input.bulk} \
            --bulk_cli {input.cli} \
            --datatype {params.datatype} \
            --mode {params.mode} \
            --save_path {params.outdir} \
            {params.norm_flag}
        """

# --- Rule 2: Analysis ---
rule run_tirank:
    input:
        # This links this rule to the previous one by requiring its output.
        prep_dir = f"{config['output_dir']}/2_preprocessing"
    output:
        # We can also track the whole directory for other outputs.
        res_dir = directory(f"{config['output_dir']}/3_Analysis")
    params:
        datatype = config["datatype"],
        mode = config["mode"],
        outdir = config["output_dir"],
        device = config["model"]["device"],
        tol = config["model"]["tolerance"]
    # conda:
    #     "../installation/environment.yml"
    shell:
        """
        python ../tirank/tirank_cli.py run \
            --save_path {params.outdir} \
            --datatype {params.datatype} \
            --mode {params.mode} \
            --device {params.device} \
            --tolerance {params.tol}
        """